// Require bcrypt
const bcrypt = require('bcrypt');

// Require model User
const User = require('./../models/User.js');

// require validator
const Validator = require('./validator');
const FlashOldInput = require('./.')

// Objek Register User
const RegisterUser = {

    // fungsi registrasi
    register: function(req, res) {

        // menjalankan fungsi validateRegister
        RegisterUser.validateRegister(req, res, (err, result, oldInput) => {
            if(err) {
                for (const key in oldInput) {
                    req.flash(`old${key}`, oldInput[key]);
                }
                req.flash(result.input, result.message);
                res.redirect('/user/register');
            }
        });

        // melakukan validasi input
        Validator(req, {
            nama: 'required|min:3|max:50',
            email: 'required|min:3|max:50',
            username: 'required|min:4|max:50',
            password: 'required|equal:password_confirmation|min:6',
        }, (err, result) => {
            if(err) {
                for (const key in req.body) {
                    req.flash(`old${key}`, req.body[key]);
                }
                req.flash(result.input, result.message);
                res.status(200);
                res.redirect('/user/register');
            }
        });

        // menjalankan fungsi untuk create user
        RegisterUser.createUser(req, res, (err, result) => {
            if(err) throw err;
            res.redirect('/');
        });

    },

    // fungsi validateRegister
    validateRegister: function(req, res, callback) {

        // cari berdasarkan email
        User.findByEmail(req.body.email, (err, result) => {
            // Check if query is error
            if(err) throw err;
            
            // check if email is already exists
            if(result.length > 0) {
                callback(true, {
                    input: 'email',
                    message: 'email sudah digunakan',
                }, req.body);
            }
        });

        // cari berdasarkan username
        User.findByUsername(req.body.username, (err, result) => {
            // check if query is error
            if(err) throw err;

            // check if username is already exists
            if(result.length > 0) {
                callback(true, {
                    input: 'username',
                    message: 'username sudah digunakan',
                }, req.body);
            }
        });
    },

    // fungsi create user
    createUser: function(req, callback) {
        // material for hash password
        const saltRound = 10;
        const password = req.body.password;

        // hashing password
        bcrypt.hash(password, saltRound, (err, hash) => {
            if(err) throw err;

            // Create User
            User.create({
                nama: req.body.nama,
                email: req.body.email,
                username: req.body.username,
                password: hash,
            }, (err, result) => {
                if(err) throw err;
            });
        });
    }
}

// export
module.exports = RegisterUser;

















        // User.findByColumn('email', req.body.email, (result) => {
        //     if(result.length > 0 ) {
        //         const oldInput = req.body;
                
        //         FlashOldInput(req);
        //         req.flash('email', 'email sudah digunakan');
        //         res.redirect('/user/register');
        //     } else {
        //         // material for hash password
        //         const saltRound = 10;
        //         const password = req.body.password;

        //         // hashing password
        //         bcrypt.hash(password, saltRound, (err, hash) => {
        //             if(err) throw err;
                    
        //             User.create({
        //                 nama: req.body.nama,
        //                 email: req.body.email,
        //                 username: req.body.username,
        //                 password: hash,
        //             });

        //             req.flash('success', 'Registrasi akun');
        //             res.redirect('/user/login');
        //         })
        //     }
        // });